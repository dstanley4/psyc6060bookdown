---
output:
  pdf_document: default
  html_document: default
---

# Deeper dive sampling [under construction]

## Previously: Equal Population Means

In the last chapter, we examined the scenario where there was distribution of sample means where the sample means differed due to random sampling only. In this chapter, examine the scenario with multiple populations where the population means are different. We specifically focus on the variance of the distribution of sample means because that is theoretical foundation for Analysis of Variance (ANOVA). We begin, however, in the simple situation of a single population.


## Theory sample mean variance 

### Single population (theory)

Recall that when there is a single population we express the variance in sample means using the formula below. This formula is conceptual one that calculates the variance in sample means due to sampling error for a given population variance and sample size.

$$
\begin{aligned} 
\sigma_{\bar{x}}^2 &= \text{variance due to sampling error}\\
&= \frac{\sigma_{people}^2}{n}\\
\end{aligned}
$$


### Multiple populations (theory)

When there are multiple populations with identical variances, but different population means, that same formula applies for sampling error. That is, because the populations of people all of have the same variance, we can use the old formula to calculate the variability in sample means due to sampling error. 

$$
\begin{aligned} 
\text{variance due to sampling error} &= \frac{\sigma_{people}^2}{n}\\
\end{aligned}
$$


However, when there are multiple populations we also have to take into account the **variability in population means** when determining the *variance of sample means*. We use $A$ to indicate the number of populations. If there are three populations then $A = 3$. We use the formula below to calculate the variance of the population means:

$$
\begin{aligned} 
\text{variance in population means} &= \sigma_{\mu_A}^2 \\
&= \frac{\sum (\mu_{A_i}-\mu_{\mu_A})^2}{A} \\
\end{aligned}
$$


where 

$$
\begin{aligned} 
\mu_{\mu_A} &=  \frac{\sum{\mu_A}}{A}
\end{aligned} 
$$


So when there are multiple populations the variability in sample means is due to both sampling error and the variability in population means.

$$
\begin{aligned} 
\sigma_{\bar{x}}^2 &= \text{variance due to sampling error} + \text{variance in population means} \\
&= \frac{\sigma_{people}^2}{n} + \sigma_{\mu_A}^2\\
\end{aligned}
$$


Importantly, if the populations all have the same mean then  $\sigma_{\mu_A}^2=0$. When this happens, sample means differ only due to sampling error. 

## Practice sample mean variance 


### Single population (practice)

Let's quickly revisit the scenario where there is a single population with a mean of 172.50 and a variance of 156.3236. Sample means (n = 5) will only differ due to sampling error. We can calculate the variance due to sampling error with the equation below.

$$
\begin{aligned} 
\text{variance due to sampling error} &= \frac{\sigma_{people}^2}{n}\\
&= 156.3236 / 5\\
&= 31.26472\\
\end{aligned}
$$

Thus, where there is a single population (with variance 156.3236) and the sample size is n = 5, sample means will differ only due to sampling error. The variance in the sample means will be 31.26472.


We can confirm this with the R code below. We create a population and then take 9,000 sample means.


```{r,include = FALSE}
library(tidyverse)
```

```{r}
library(tidyverse)
library(learnSampling)

set.seed(1)
pop1 <- make_population(mean = 172.50, variance = 156.3236)

set.seed(1)
sample_means <- get_mean_samples(pop1,
                                 n = 5,
                                 number.of.trials = 9000)
```

The first few rows of the data set with 9,000 sample mean is below:

```{r}
head(sample_means)
```

The trial column indicate which trial (of the 10,000) is represented in that row. The source population column indicate the population we obtain the sample from (1 since we only had 1 population). The sample mean column indicate the sample mean in that trial.

```{r}
sample_means %>%
  summarise(var_means = var(sample_mean))
```

We take the variance of all of those sample means and get a value of 30.80005 which closely approximately the actual value of 31.26472 (which we get when using an infinite number of sample means.)

### Multiples population, equal $\mu$ (practice)

Now let's see what happens when we have three populations with different means - as illustrated in the table and figure below. Notice the mean for all three populations is 172.50 in the table below.


| Population |  Mean        | Variance        |
|:----------:|:------------:|:----------------|
| 1          | $\mu_{A1_{people}}= 172.50$ |  $\sigma_{1_{people}}^2= 156.3236$ |
| 2          | $\mu_{A2_{people}}= 172.50$ |  $\sigma_{2_{people}}^2= 156.3236$ |
| 3          | $\mu_{A3_{people}}= 172.50$ |  $\sigma_{3_{people}}^2= 156.3236$ |


We created a scenario where the sample means differed to random sampling only when we created three populations with identical means (and variances). This situation is depicted in the scenario below.

```{r sim3poprepeat, out.width = "100%", echo=FALSE, fig.cap= "Sampling from three populations with the same mean (and variance)"}
knitr::include_graphics("ch_deeper_sampling/images/pop_equal_means.png")
```


Because the populations have equal variances we calculate the variance due to sampling error the way we did previously:

$$
\begin{aligned} 
\text{variance due to sampling error} &= \frac{\sigma_{people}^2}{n}\\
&= 156.3236 / 5\\
&= 31.26472\\
\end{aligned}
$$


But we also have to calculate the variance in population means. But to calculate the variance of the population means we need the mean of the population means. This value is calculated below - it's simply the average of 172.50 repeated three times:

$$
\begin{aligned} 
\mu_{\mu_A} &=  \frac{\sum{\mu_A}}{A} \\
&=  \frac{\mu_{A1}+\mu_{A2}+\mu_{A3}}{A} \\
&=  \frac{172.50 + 172.50 + 172.50}{3} \\
&= \frac{517.50}{3}\\
&= 172.50 \\
\end{aligned}
$$

We use this value to calculate the variance of the population means. Which we find to be 0 because the population means are all the same.

$$
\begin{aligned} 
\sigma_{\mu_A}^2 &=  \frac{\sum (\mu_{A_i}-\mu_{\mu_A})^2}{A} \\
&=  \frac{(\mu_{A_1} - \mu_{\mu_A})^2 + (\mu_{A_2} - \mu_{\mu_A})^2 + (\mu_{A_3} - \mu_{\mu_A})^2}{3} \\
&=  \frac{(172.50 - 172.50)^2 + (172.50 - 172.50)^2 + (172.50 - 172.50)^2}{3} \\
&=  \frac{0}{3} \\
&=  0\\
\end{aligned}
$$

So the total variance is sample means is:

$$
\begin{aligned} 
\sigma_{\bar{x}}^2 &= \text{variance due to sampling error} + \text{variance in population means} \\
&= \frac{\sigma_{people}^2}{n} + \sigma_{\mu_A}^2\\
&= 31.26472 + 0
&= 31.26472
\end{aligned}
$$

We can confirm this with the simulation below. **In this simulation we still take 9000 sample means but its 3000 from each of the three populations**.

```{r}
library(tidyverse)
library(learnSampling)

set.seed(1)
pop1 <- make_population(mean = 172.50, variance = 156.3236)
pop2 <- pop1 # populations are identical
pop3 <- pop1 # populations are identical

set.seed(1)
sample_means <- get_mean_samples(pop1, pop2, pop3,
                                 n = 5,
                                 number.of.trials = 9000)
```

The first few rows of the data set with 9,000 sample mean is below:

```{r}
head(sample_means)
```

The trial column indicate which trial (of the 9,000) is represented in that row. The source population column indicate the population we obtain the sample from (1 since we only had 1 population). The sample mean column indicate the sample mean in that trial.

```{r}
sample_means %>%
  summarise(var_means = var(sample_mean))
```


We take the variance of all of those sample means and get a value of 30.80005 which closely approximately the actual value of 31.26472 (which we get when using an infinite number of sample means.) 


**That is, when multiple populations have identical means, the variance of sample means from those populations is due entirely to sampling error. That variance of sample means is represented by the formula below:**

$$
\begin{aligned} 
\text{variance due to sampling error} &= \frac{\sigma_{people}^2}{n}\\
\end{aligned}
$$



### Multiples population, different $\mu$ (practice)

Now let's see what happens when we have three populations with different means - as illustrated in the table and figure below.

| Population |  Mean        | Variance        |
|:----------:|:------------:|:----------------|
| 1          | $\mu_{A1_{people}}= 152.50$ |  $\sigma_{1_{people}}^2= 156.3236$ |
| 2          | $\mu_{A2_{people}}= 172.50$ |  $\sigma_{2_{people}}^2= 156.3236$ |
| 3          | $\mu_{A3_{people}}= 192.50$ |  $\sigma_{3_{people}}^2= 156.3236$ |



```{r sim3poprepeatunequal, out.width = "100%", echo=FALSE, fig.cap= "Sampling from three populations with the same mean (and variance)"}
knitr::include_graphics("ch_deeper_sampling/images/pop_unequal_means.png")
```


Because the populations have equal variances (even if the means are different) we calculate the variance due to sampling error the way we did previously:

$$
\begin{aligned} 
\text{variance due to sampling error} &= \frac{\sigma_{people}^2}{n}\\
&= 156.3236 / 5\\
&= 31.26472\\
\end{aligned}
$$


But we also have to calculate the variance in population means. But to calculate the variance of the population means we need the mean of the population means. This value is calculated below - notice that we are simply averaging the three population means: 152.5, 172.5, and 192.5.

$$
\begin{aligned} 
\mu_{\mu_A} &=  \frac{\sum{\mu_A}}{A} \\
&=  \frac{\mu_{A1}+\mu_{A2}+\mu_{A3}}{A} \\
&=  \frac{152.50 + 172.50 + 192.50}{3} \\
&= \frac{517.50}{3}\\
&= 172.50 \\
\end{aligned}
$$

We use this value to calculate the variance of the population means. Which we find to be 0 because the population means are all the same.

$$
\begin{aligned} 
\sigma_{\mu_A}^2 &=  \frac{\sum (\mu_{A_i}-\mu_{\mu_A})^2}{A} \\
&=  \frac{(\mu_{A_1} - \mu_{\mu_A})^2 + (\mu_{A_2} - \mu_{\mu_A})^2 + (\mu_{A_3} - \mu_{\mu_A})^2}{3} \\
&=  \frac{(152.50 - 172.50)^2 + (172.50 - 172.50)^2 + (192.50 - 172.50)^2}{3} \\
&=  \frac{(-20)^2 + (0)^2 + (20)^2}{3} \\
&=  \frac{400 + 0 + 400}{3} \\
&=  \frac{800}{3} \\
&=  266.6667\\
\end{aligned}
$$

So the total variance is sample means is:

$$
\begin{aligned} 
\sigma_{\bar{x}}^2 &= \text{variance due to sampling error} + \text{variance in population means} \\
&= \frac{\sigma_{people}^2}{n} + \sigma_{\mu_A}^2\\
&= 31.26472 + 266.6667\\
&= 297.9314\\
\end{aligned}
$$

We can confirm this with the simulation below. **In this simulation we still take 9000 sample means but its 3000 from each of the three populations**.

```{r}
library(tidyverse)
library(learnSampling)

set.seed(1)
pop1 <- make_population(mean = 172.50, variance = 156.3236)
pop2 <- make_population(mean = 152.50, variance = 156.3236)
pop3 <- make_population(mean = 192.50, variance = 156.3236)

set.seed(1)
sample_means <- get_mean_samples(pop1, pop2, pop3,
                                 n = 5,
                                 number.of.trials = 9000)
```

The first few rows of the data set with 9,000 sample mean is below:

```{r}
head(sample_means)
```

The trial column indicate which trial (of the 9,000) is represented in that row. The source population column indicate the population we obtain the sample from (1 since we only had 1 population). The sample mean column indicate the sample mean in that trial.

```{r}
sample_means %>%
  summarise(var_means = var(sample_mean))
```


We take the variance of all of those sample means and get a value of 297.7683 which closely approximately the actual value of 297.9314 (which we get when using an infinite number of sample means.)

**That is, when multiple populations have different means, the variance of sample means from those populations is due to both sampling error and the variance of the population means. That variance of sample means is represented by the formula below:**

$$
\begin{aligned} 
\sigma_{\bar{x}}^2 &= \frac{\sigma_{people}^2}{n} + \sigma_{\mu_A}^2\\
\end{aligned}
$$

##  Summary


|          Attribute           |                                  Parameter Calculation                                   |                               Estimate of Parameter                               | Reflects         |
|:----------------------------:|:----------------------------------------------------------------------------------------:|:---------------------------------------------------------------------------------:|:----------------:|
|      Method 1: Variance      |  $\sigma_{\bar{x}}^2 = \frac{\sum_{i=1}^{K=\infty}{(\bar{x}_i - \mu_{\bar{x}})^2}}{K}$   |    $s_{\bar{x}}^2 = \frac{\sum_{i=1}^{a}{(\bar{x}_i - \bar{\bar{x}})^2}}{a-1}$    | Sampling Error & Variance of Population Means |
|    Method 2 CLT: Variance    |                    $\sigma_{\bar{x}}^2 = \frac{\sigma_{people}^2}{n}$                    |                     $s_{\bar{x}}^2 = \frac{s_{people}^2}{n}$                      | Just Sampling Error |

